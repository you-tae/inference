#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from std_msgs.msg import Float32MultiArray
import socket
import subprocess
import numpy as np
import threading

from utils import extract_log_mel_spectrogram  # ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ë³€í™˜ í•¨ìˆ˜
from parameters import params  # data_generator.pyì™€ ë™ì¼í•œ íŒŒë¼ë¯¸í„° ë”•ì…”ë„ˆë¦¬

class AudioBufferNode(Node):
    def __init__(self):
        super().__init__('audio_buffer_node')
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 1) paramsì—ì„œ í•„ìš”í•œ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ê¸¸ì´ (ì´ˆ)
        self.ws = 1  # ì˜ˆì‹œ: 1ì´ˆì§œë¦¬ ìœˆë„ìš°

        # data_generator.pyì™€ ë™ì¼í•œ í‚¤ ì´ë¦„ ì‚¬ìš©
        self.sr = params['SAMPLE_RATE']      # ì˜ˆ: 24000, 16000 ë“±
        self.n_fft = params['N_FFT']         # ì˜ˆ: 1024, 2048 ë“±
        self.hop_length = params['HOP_LENGTH']   # ì˜ˆ: 256, 512 ë“±
        self.win_length = params['WIN_LENGTH']   # ì˜ˆ: 512, 1024 ë“±
        self.nb_mels = params['nb_mels']     # ë©œ ë°´ë“œ ê°œìˆ˜ (ì˜ˆ: 64, 80 ë“±)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 2) ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë²„í¼ í¬ê¸° ê³„ì‚°
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ìœˆë„ìš°(ìŠ¬ë¼ì´ë”©) ê¸¸ì´: self.ws (ì´ˆ) * self.sr (ìƒ˜í”Œ/ì´ˆ)
        self.window_samps = int(self.sr * self.ws)
        # ì±„ë„ë³„ int16 ë²„í¼ ì´ˆê¸°í™”
        self.buf_l = np.zeros(self.window_samps, dtype=np.int16)
        self.buf_r = np.zeros(self.window_samps, dtype=np.int16)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 3) ROS í¼ë¸”ë¦¬ì…” ì„¤ì •
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Float32MultiArray ë©”ì‹œì§€ë¡œ mel-spectrogramì„ í¼ë¸”ë¦¬ì‹œ
        self.pub = self.create_publisher(Float32MultiArray, 'mel_spectogram', 10)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 4) ADB reverse ìë™ ì‹¤í–‰ (Android ë””ë°”ì´ìŠ¤ ì—°ê²°ìš©)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self.setup_adb_reverse()

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 5) ì„œë²„ ì†Œì¼“ ì„¤ì • (TCPë¡œ ì˜¤ë””ì˜¤ ìƒ˜í”Œ ìˆ˜ì‹ )
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        self.server_socket.bind(('0.0.0.0', 5005))
        self.server_socket.listen(1)
        self.conn, _ = self.server_socket.accept()

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 6) ìˆ˜ì‹  ì „ìš© ìŠ¤ë ˆë“œ ì‹œì‘
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        threading.Thread(target=self.recv_loop, daemon=True).start()
        self.get_logger().info('AudioBufferNode started.')

    def setup_adb_reverse(self):
        """ADB reverseë¥¼ ìë™ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜"""
        try:
            self.get_logger().info("ğŸ“¡ Setting up ADB reverse...")
            subprocess.run(['adb', 'reverse', 'tcp:5005', 'tcp:5005'], check=True)
            self.get_logger().info("âœ… ADB reverse successful.")
        except subprocess.CalledProcessError as e:
            self.get_logger().error(f"â— ADB reverse failed: {e}")
            rclpy.shutdown()

    def recv_loop(self):
        """TCP ì†Œì¼“ì„ í†µí•´ ë°ì´í„°ë¥¼ ë°›ëŠ” í•¨ìˆ˜"""
        while rclpy.ok():
            # í•œ ë²ˆì— ìµœëŒ€ 4096ë°”ì´íŠ¸ë§Œí¼ ì½ìŒ
            data = self.conn.recv(4096)
            if not data:
                break

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 1) ë°›ì€ ë°”ì´ë„ˆë¦¬ë¥¼ int16 ìƒ˜í”Œë¡œ ë³€í™˜
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            samples = np.frombuffer(data, dtype=np.int16)
            # í™€ìˆ˜ê°œ ìƒ˜í”Œì´ ë“¤ì–´ì˜¬ ê²½ìš° ë§ˆì§€ë§‰ í•˜ë‚˜ ë²„ë¦¼
            if samples.size % 2:
                samples = samples[:-1]
            # ìŠ¤í…Œë ˆì˜¤: ì§ìˆ˜ ì¸ë±ìŠ¤â†’ì™¼ìª½, í™€ìˆ˜ ì¸ë±ìŠ¤â†’ì˜¤ë¥¸ìª½
            l, r = samples[::2], samples[1::2]

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 2) ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë²„í¼ ê°±ì‹ 
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # ì´ì „ ë²„í¼ + ìƒˆ ìƒ˜í”Œì„ ë¶™ì´ê³ , ë’¤ì—ì„œë¶€í„° window_sampsë§Œí¼ ìœ ì§€
            self.buf_l = np.concatenate((self.buf_l, l))[-self.window_samps:]
            self.buf_r = np.concatenate((self.buf_r, r))[-self.window_samps:]

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 3) int16 â†’ float32ë¡œ ë³€í™˜
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            buf_l_float = self.buf_l.astype(np.float32)
            buf_r_float = self.buf_r.astype(np.float32)

            # ì±„ë„ ì¶•(0) ê¸°ì¤€ìœ¼ë¡œ ìŠ¤íƒí•˜ì—¬ (2, window_samps) ëª¨ì–‘ ìƒì„±
            combined_buf = np.stack([buf_l_float, buf_r_float], axis=0)

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 4) ë¡œê·¸ ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ì¶”ì¶œ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            log_mel = extract_log_mel_spectrogram(
                combined_buf,
                sr=self.sr,
                n_fft=self.n_fft,
                hop_length=self.hop_length,
                win_length=self.win_length,
                nb_mels=self.nb_mels
            )
            # log_melì˜ shape ì˜ˆì‹œ: (2, time_frames, nb_mels) 
            # -- ì±„ë„ ì¶•ì´ ì²« ë²ˆì§¸ì´ë¯€ë¡œ 2ê°œ ì±„ë„ ë¶„ë¦¬ëœ ê²°ê³¼

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 5) ROS í† í”½ìœ¼ë¡œ í¼ë¸”ë¦¬ì‹œ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            msg = Float32MultiArray()
            # 3D ë°°ì—´ì„ 1D ë¦¬ìŠ¤íŠ¸ë¡œ í¼ì³ì„œ ì „ì†¡
            msg.data = log_mel.astype(np.float32).ravel().tolist()
            self.pub.publish(msg)

        self.get_logger().info('AudioBufferNode terminating.')
        self.conn.close()

def main():
    rclpy.init()
    node = AudioBufferNode()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()